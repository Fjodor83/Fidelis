@page "/assegna-punti"
@using Fidelity.Client.Services
@using Fidelity.Client.Services.Interfaces
@using Fidelity.Shared.DTOs
@inject IAuthService AuthService
@inject IClienteService ClienteService
@inject ITransazioneService TransazioneService
@inject ICouponService CouponService
@inject NavigationManager Navigation

<PageTitle>Assegna Punti - Suns</PageTitle>

<div class="min-vh-100" style="background-color: #f8f9fa;">
    <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #105a12ff 0%, #053e30ff 100%);">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">☀️ Assegna Punti Fedeltà</span>
            <div class="d-flex align-items-center gap-3">
                <span class="text-white">
                    <i class="bi bi-person-circle"></i> @nomeCompleto
                    @if (ruolo == "Admin")
                    {
                        <span class="badge bg-warning text-dark ms-2">ADMIN</span>
                    }
                    else
                    {
                        <span class="badge bg-info text-dark ms-2">@puntoVenditaCodice</span>
                    }
                </span>
                <button class="btn btn-outline-light btn-sm" @onclick="TornaDashboard">
                    <i class="bi bi-arrow-left"></i> Indietro
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                
                <!-- Card Cerca Cliente -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0"><i class="bi bi-search me-2"></i>Cerca Cliente</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-0">
                            <label class="form-label fw-bold">Codice Fedeltà</label>
                            <div class="input-group input-group-lg">
                                <input @bind="codiceFidelity" 
                                       @bind:event="oninput"
                                       @onkeypress="@(async e => { if (e.Key == "Enter") await CercaCliente(); })"
                                       class="form-control" 
                                       placeholder="SUN123456789"
                                       maxlength="12" />
                                <button class="btn btn-primary px-4" @onclick="CercaCliente" disabled="@isLoading">
                                    @if (isLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-search me-2"></i>Cerca
                                </button>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle me-1"></i>Inquadra il QR Code o inserisci manualmente il codice
                            </small>
                        </div>

                        @if (!string.IsNullOrEmpty(messaggioErrore))
                        {
                            <div class="alert alert-danger mt-3 mb-0">
                                <i class="bi bi-exclamation-triangle"></i> @messaggioErrore
                            </div>
                        }
                    </div>
                </div>

                @if (clienteTrovato != null)
                {
                    <!-- Card Info Cliente -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header text-white py-3" style="background: linear-gradient(135deg, #105a12ff 0%, #053e30ff 100%);">
                            <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Cliente Trovato</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <h4 class="mb-2">@clienteTrovato.Nome @clienteTrovato.Cognome</h4>
                                    <p class="mb-1"><strong>Email:</strong> @clienteTrovato.Email</p>
                                    <p class="mb-1"><strong>Telefono:</strong> @clienteTrovato.Telefono</p>
                                    <p class="mb-0"><strong>Registrato:</strong> @clienteTrovato.DataRegistrazione.ToLocalTime().ToString("dd/MM/yyyy")</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <div class="mb-2">
                                        <span class="badge bg-primary px-3 py-2" style="font-size: 0.9rem;">
                                            @clienteTrovato.CodiceFidelity
                                        </span>
                                    </div>
                                    <h2 class="mb-0" style="color: #105a12ff;">
                                        <i class="bi bi-star-fill me-2"></i>@clienteTrovato.PuntiTotali punti
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs mb-4">
                        <li class="nav-item">
                            <button class="nav-link @(activeTab == "punti" ? "active" : "")" @onclick='() => activeTab = "punti"'>
                                <i class="bi bi-star me-2"></i>Gestione Punti
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link @(activeTab == "coupons" ? "active" : "")" @onclick='() => LoadCouponsTab()'>
                                <i class="bi bi-ticket-perforated me-2"></i>Gestione Coupon
                            </button>
                        </li>
                    </ul>

                    @if (activeTab == "punti")
                    {
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Assegna Nuovi Punti</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Importo Spesa (€)</label>
                                        <input @bind="importoSpesa" 
                                               @bind:event="oninput"
                                               type="number" 
                                               step="0.01"
                                               class="form-control form-control-lg" 
                                               placeholder="0.00" />
                                        <small class="text-muted">1 punto ogni 10€ spesi</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Punti da Assegnare</label>
                                        <div class="input-group input-group-lg">
                                            <input type="text" 
                                                   value="@puntiCalcolati" 
                                                   class="form-control" 
                                                   readonly 
                                                   style="background-color: #e9ecef; font-weight: bold; color: #105a12ff;" />
                                            <span class="input-group-text">
                                                <i class="bi bi-star-fill" style="color: #105a12ff;"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Note (opzionale)</label>
                                    <input @bind="noteTransazione" class="form-control" placeholder="Es: Acquisto scarpe sportive" />
                                </div>

                                @if (!string.IsNullOrEmpty(messaggioSuccesso))
                                {
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle"></i> @messaggioSuccesso
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(messaggioErroreAssegnazione))
                                {
                                    <div class="alert alert-danger">
                                        <i class="bi bi-exclamation-triangle"></i> @messaggioErroreAssegnazione
                                    </div>
                                }

                                <div class="d-grid gap-2">
                                    <button class="btn btn-success btn-lg" 
                                            @onclick="AssegnaPuntiAsync"
                                            disabled="@(isAssegnando || importoSpesa <= 0 || puntiCalcolati < 1)"
                                            style="background: linear-gradient(135deg, #105a12ff 0%, #053e30ff 100%); border: none;">
                                        @if (isAssegnando)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <span>Assegnazione in corso...</span>
                                        }
                                        else
                                        {
                                            <span><i class="bi bi-check-circle me-2"></i>Conferma e Assegna @puntiCalcolati Punti</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>

                        @if (clienteTrovato.UltimeTransazioni.Any())
                        {
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white border-0 py-3">
                                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Ultime Transazioni</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Data</th>
                                                    <th>Punti</th>
                                                    <th>Importo</th>
                                                    <th>Negozio</th>
                                                    <th>Tipo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var t in clienteTrovato.UltimeTransazioni)
                                                {
                                                    <tr>
                                                        <td><small>@t.DataTransazione.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small></td>
                                                        <td><span class="badge bg-primary">+@t.PuntiGuadagnati</span></td>
                                                        <td>
                                                            <span>@t.Importo.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("it-IT"))</span>
                                                        </td>
                                                        <td><small>@t.PuntoVenditaNome</small></td>
                                                        <td><span class="badge bg-success">@t.Tipo</span></td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    
                    @if (activeTab == "coupons")
                    {
                        <div class="row">
                            <div class="col-md-7 mb-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-white border-0 py-3">
                                        <h5 class="mb-0"><i class="bi bi-person-video2 me-2"></i>Coupon del Cliente</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        @if (isLoadingCoupons)
                                        {
                                            <LoadingSpinner Message="Caricamento coupon..." />
                                        }
                                        else if (couponsCliente.Any())
                                        {
                                            <div class="list-group list-group-flush">
                                                @foreach (var c in couponsCliente)
                                                {
                                                    <div class="list-group-item p-3">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <h6 class="mb-1 text-primary fw-bold">@c.Titolo</h6>
                                                                <p class="mb-1 small text-muted">@c.Descrizione</p>
                                                                <div class="small">
                                                                    <span class="badge bg-light text-dark border me-2">@c.Codice</span>
                                                                    @if (c.TipoSconto == "Percentuale")
                                                                    {
                                                                        <span class="badge bg-info text-dark">@c.ValoreSconto.ToString("0")% OFF</span>
                                                                    }
                                                                    else
                                                                    {
                                                                        <span class="badge bg-success">@c.ValoreSconto.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("it-IT")) OFF</span>
                                                                    }
                                                                </div>
                                                                @if (c.Utilizzato)
                                                                {
                                                                    <div class="mt-2 small text-muted">
                                                                        <i class="bi bi-check-all"></i> Usato il @c.DataUtilizzo?.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                                                    </div>
                                                                }
                                                                else if (c.Scaduto)
                                                                {
                                                                    <div class="mt-2 small text-danger"><i class="bi bi-clock"></i> Scaduto</div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="mt-2 small text-success"><i class="bi bi-check-circle"></i> Valido fino al @c.DataScadenza.ToString("dd/MM/yyyy")</div>
                                                                }
                                                            </div>
                                                            <div>
                                                                @if (!c.Utilizzato && !c.Scaduto)
                                                                {
                                                                    <button class="btn btn-sm btn-outline-success" 
                                                                            @onclick="() => RiscattaCoupon(c.Id)"
                                                                            disabled="@isRiscattando">
                                                                        Riscatta
                                                                    </button>
                                                                }
                                                                else if (c.Utilizzato)
                                                                {
                                                                    <span class="badge bg-secondary">Usato</span>
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center py-5 text-muted">
                                                <i class="bi bi-ticket-perforated display-6 mb-3 d-block"></i>
                                                Nessun coupon assegnato.
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-5 mb-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-white border-0 py-3">
                                        <h5 class="mb-0"><i class="bi bi-gift me-2"></i>Assegna Nuovo</h5>
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Seleziona Coupon</label>
                                            <select @bind="selectedCouponId" class="form-select form-select-lg">
                                                <option value="0">-- Scegli un coupon --</option>
                                                @foreach (var c in couponsDisponibili)
                                                {
                                                    <option value="@c.Id">@c.Titolo (@c.Codice)</option>
                                                }
                                            </select>
                                        </div>

                                        <button class="btn btn-primary w-100 btn-lg" 
                                                @onclick="AssegnaCoupon"
                                                disabled="@(selectedCouponId == 0 || isRiscattando)">
                                            <i class="bi bi-plus-circle me-2"></i>Assegna al Cliente
                                        </button>

                                        @if (!string.IsNullOrEmpty(messaggioCoupon))
                                        {
                                            <div class="alert alert-success mt-3">@messaggioCoupon</div>
                                        }
                                        @if (!string.IsNullOrEmpty(erroreCoupon))
                                        {
                                            <div class="alert alert-danger mt-3">@erroreCoupon</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private string nomeCompleto = "";
    private string puntoVenditaCodice = "";
    private string ruolo = "";

    private string codiceFidelity = "";
    private ClienteDetailDto? clienteTrovato = null;

    private decimal _importoSpesa = 0;
    private decimal importoSpesa 
    {
        get => _importoSpesa;
        set 
        {
            _importoSpesa = value;
            puntiCalcolati = (int)(_importoSpesa * 0.1m);
        }
    }
    private int puntiCalcolati = 0;
    private string noteTransazione = "";

    private bool isLoading = false;
    private bool isAssegnando = false;
    private string messaggioErrore = "";
    private string messaggioErroreAssegnazione = "";
    private string messaggioSuccesso = "";

    private string activeTab = "punti";
    private List<CouponAssegnatoDTO> couponsCliente = new();
    private List<CouponDTO> couponsDisponibili = new();
    private int selectedCouponId = 0;
    private bool isRiscattando = false;
    private bool isLoadingCoupons = false;
    private string messaggioCoupon = "";
    private string erroreCoupon = "";

    protected override async Task OnInitializedAsync()
    {
        if (!await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/login-responsabile");
            return;
        }

        nomeCompleto = await GetNomeCompletoAsync();
        ruolo = await AuthService.GetRoleAsync() ?? "";
        puntoVenditaCodice = await GetPuntoVenditaCodiceAsync();
    }

    private async Task CercaCliente()
    {
        if (string.IsNullOrWhiteSpace(codiceFidelity) || codiceFidelity.Length < 12)
        {
            messaggioErrore = "Inserisci un codice fedeltà valido (12 caratteri).";
            return;
        }

        isLoading = true;
        messaggioErrore = "";
        clienteTrovato = null;

        try
        {
            clienteTrovato = await ClienteService.GetClienteDettaglioAsync(codiceFidelity.Trim());
            
            if (clienteTrovato == null)
            {
                messaggioErrore = $"Nessun cliente trovato con codice '{codiceFidelity}'.";
            }
        }
        catch (Exception ex)
        {
            messaggioErrore = "Errore durante la ricerca del cliente.";
            Console.Error.WriteLine($"Error searching client: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task AssegnaPuntiAsync()
    {
        if (clienteTrovato == null || importoSpesa <= 0 || puntiCalcolati < 1)
            return;

        isAssegnando = true;
        messaggioErroreAssegnazione = "";
        messaggioSuccesso = "";

        try
        {
            var request = new AssegnaPuntiRequest
            {
                CodiceFidelity = clienteTrovato.CodiceFidelity,
                ImportoSpesa = importoSpesa,
                Note = noteTransazione
            };

            var transazione = await TransazioneService.AssegnaPuntiAsync(request);

            if (transazione != null)
            {
                messaggioSuccesso = $"✓ Assegnati {transazione.PuntiGuadagnati} punti con successo!";
                
                clienteTrovato = clienteTrovato! with { PuntiTotali = clienteTrovato.PuntiTotali + transazione.PuntiGuadagnati };
                clienteTrovato.UltimeTransazioni.Insert(0, transazione);

                importoSpesa = 0;
                puntiCalcolati = 0;
                noteTransazione = "";

                await Task.Delay(5000);
                messaggioSuccesso = "";
            }
            else
            {
                messaggioErroreAssegnazione = "Errore durante l'assegnazione dei punti.";
            }
        }
        catch (Exception ex)
        {
            messaggioErroreAssegnazione = "Errore di connessione.";
            Console.Error.WriteLine($"Error assigning points: {ex.Message}");
        }
        finally
        {
            isAssegnando = false;
        }
    }

    private async Task LoadCouponsTab()
    {
        activeTab = "coupons";
        
        if (clienteTrovato == null)
            return;

        if (!couponsCliente.Any())
        {
            isLoadingCoupons = true;
            try
            {
                couponsCliente = await CouponService.GetCouponsClienteAsync(clienteTrovato.Id);
                couponsDisponibili = await CouponService.GetCouponsDisponibiliAsync();
            }
            finally
            {
                isLoadingCoupons = false;
            }
        }
    }

    private async Task RiscattaCoupon(int couponAssegnatoId)
    {
        isRiscattando = true;
        messaggioCoupon = "";
        erroreCoupon = "";

        try
        {
            var success = await CouponService.RiscattaCouponAsync(new RiscattaCouponRequest 
            { 
                CouponAssegnatoId = couponAssegnatoId 
            });

            if (success && clienteTrovato != null)
            {
                messaggioCoupon = "Coupon riscattato con successo!";
                couponsCliente = await CouponService.GetCouponsClienteAsync(clienteTrovato.Id);
                await Task.Delay(3000);
                messaggioCoupon = "";
            }
            else
            {
                erroreCoupon = "Errore durante il riscatto del coupon.";
            }
        }
        catch (Exception ex)
        {
            erroreCoupon = "Errore di connessione.";
            Console.Error.WriteLine($"Error redeeming coupon: {ex.Message}");
        }
        finally
        {
            isRiscattando = false;
        }
    }

    private async Task AssegnaCoupon()
    {
        if (selectedCouponId == 0 || clienteTrovato == null)
            return;

        isRiscattando = true;
        messaggioCoupon = "";
        erroreCoupon = "";

        try
        {
            var success = await CouponService.AssegnaCouponAsync(new AssegnaCouponRequest
            {
                ClienteId = clienteTrovato.Id,
                CouponId = selectedCouponId
            });

            if (success)
            {
                messaggioCoupon = "Coupon assegnato con successo!";
                couponsCliente = await CouponService.GetCouponsClienteAsync(clienteTrovato.Id);
                selectedCouponId = 0;
                await Task.Delay(3000);
                messaggioCoupon = "";
            }
            else
            {
                erroreCoupon = "Errore durante l'assegnazione.";
            }
        }
        catch (Exception ex)
        {
            erroreCoupon = "Errore di connessione.";
            Console.Error.WriteLine($"Error assigning coupon: {ex.Message}");
        }
        finally
        {
            isRiscattando = false;
        }
    }

    private void TornaDashboard()
    {
        Navigation.NavigateTo(ruolo == "Admin" ? "/dashboard" : "/dashboard");
    }

    private async Task<string> GetNomeCompletoAsync()
    {
        var token = await AuthService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
            return "";

        var claims = Helpers.JwtParser.ParseClaimsFromJwt(token);
        return claims.FirstOrDefault(c => c.Type == "NomeCompleto")?.Value ?? "";
    }

    private async Task<string> GetPuntoVenditaCodiceAsync()
    {
        var token = await AuthService.GetTokenAsync();
        if (string.IsNullOrEmpty(token))
            return "";

        var claims = Helpers.JwtParser.ParseClaimsFromJwt(token);
        return claims.FirstOrDefault(c => c.Type == "PuntoVenditaCodice")?.Value ?? "";
    }
}